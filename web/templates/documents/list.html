{% extends "base.html" %}

{% block content %}
<div class="flex flex-wrap items-start justify-between gap-3">
  <div>
    <p class="text-xs uppercase tracking-[0.2em] text-slate-400">Document Lab</p>
    <h2 class="text-3xl font-semibold text-white">Create · Iterate · Execute · Validate</h2>
    <p class="text-sm text-slate-400">Responsive control surface for requirements workflows.</p>
  </div>
  <div class="flex flex-wrap items-center gap-2">
    <span class="rounded-full border border-slate-800 bg-slate-900/70 px-3 py-1 text-xs font-semibold text-slate-100">
      Active doc: <span id="active-doc-chip" class="text-emerald-300">{{ workflow_state.current_doc or "None" }}</span>
    </span>
    <span class="rounded-full border border-slate-800 bg-slate-900/70 px-3 py-1 text-xs font-semibold text-slate-100">
      Repo root: {{ repo_root }}
    </span>
  </div>
</div>

<div class="mt-8 grid gap-6 xl:grid-cols-3">
  <div class="space-y-6 xl:col-span-2">
    <section class="rounded-3xl border border-slate-800 bg-slate-900/70 p-6 shadow-lg shadow-slate-900/50 ring-1 ring-white/5">
      <div class="flex flex-wrap items-start justify-between gap-4">
        <div>
          <p class="text-xs uppercase tracking-[0.16em] text-sky-200">Document creation</p>
          <h3 class="text-xl font-semibold text-white">Spin up a requirements doc from a template</h3>
          <p class="text-sm text-slate-400">Define the source template and desired output path, then publish it into the repo.</p>
        </div>
        <div class="rounded-2xl border border-slate-800 bg-slate-950/80 px-4 py-3 text-xs text-slate-300">
          <p class="font-semibold text-slate-100">Quick defaults</p>
          <p>Template: <span class="text-emerald-300">{{ defaults.template_path }}</span></p>
          <p>Document: <span class="text-emerald-300">{{ defaults.document_path }}</span></p>
        </div>
      </div>
      <form id="create-form" class="mt-6 grid gap-4 lg:grid-cols-2">
        <label class="text-sm text-slate-200 lg:col-span-2">
          Repo root
          <input id="repo-root" value="{{ repo_root }}" readonly class="mt-1 w-full cursor-not-allowed rounded-xl border border-slate-800 bg-slate-950/50 px-3 py-2 text-sm text-slate-100 outline-none ring-emerald-400/40 focus:ring" />
        </label>
        <label class="text-sm text-slate-200">
          Template path
          <input name="template_path" id="template-path" value="{{ defaults.template_path }}" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 outline-none ring-emerald-400/40 focus:ring" placeholder="docs/templates/requirements-template.md" />
        </label>
        <label class="text-sm text-slate-200">
          Document name
          <input name="document_name" id="doc-name" value="{{ defaults.document_path.rsplit('/', 1)[-1] if defaults.document_path else '' }}" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 outline-none ring-emerald-400/40 focus:ring" placeholder="requirements.md" />
        </label>
        <label class="text-sm text-slate-200">
          Document path
          <span class="block text-xs font-normal text-slate-400">Relative to the repo root; auto-fills from document name.</span>
          <input name="document_path" data-doc-path id="doc-path" value="{{ defaults.document_path }}" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 outline-none ring-emerald-400/40 focus:ring" placeholder="docs/requirements.md" />
        </label>
        <div class="lg:col-span-2 flex flex-wrap gap-3">
          <button type="submit" class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-indigo-500 via-sky-500 to-emerald-400 px-4 py-2 text-sm font-semibold text-slate-950 shadow-md shadow-sky-500/30 transition hover:translate-y-[-1px] hover:shadow-sky-400/40">
            Create from template
          </button>
          <button type="button" id="load-button" class="inline-flex items-center gap-2 rounded-xl border border-slate-700 px-4 py-2 text-sm font-semibold text-slate-100 transition hover:border-slate-500 hover:bg-slate-800/60">
            Load into editor
          </button>
          <span id="action-toast" class="rounded-full border border-slate-700 bg-slate-900/70 px-3 py-1 text-xs text-slate-300">Ready</span>
        </div>
      </form>
    </section>

    <section class="rounded-3xl border border-slate-800 bg-slate-900/70 p-6 shadow-lg shadow-slate-900/50 ring-1 ring-white/5">
      <div class="flex flex-wrap items-start justify-between gap-4">
        <div>
          <p class="text-xs uppercase tracking-[0.16em] text-sky-200">Document viewer & iteration</p>
          <h3 class="text-xl font-semibold text-white">Read, edit, and save iterations</h3>
          <p class="text-sm text-slate-400">Load the current doc, make adjustments, and persist changes back to disk.</p>
        </div>
        <div class="text-right text-xs text-slate-400">
          <p>Auto-saves to repo paths</p>
          <p class="text-emerald-300">Server-side sessions retained</p>
        </div>
      </div>
      <div class="mt-4 space-y-3">
        <div class="flex flex-wrap items-center gap-3">
          <span class="rounded-full border border-slate-800 bg-slate-950/60 px-3 py-1 text-xs font-semibold text-slate-200">
            Current path
          </span>
          <input data-doc-path class="min-w-[240px] flex-1 rounded-xl border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 outline-none ring-emerald-400/40 focus:ring" placeholder="docs/requirements.md" value="{{ defaults.document_path }}" />
          <button id="save-button" class="inline-flex items-center gap-2 rounded-xl border border-emerald-500/60 bg-emerald-400/10 px-4 py-2 text-sm font-semibold text-emerald-100 transition hover:border-emerald-300 hover:bg-emerald-400/20">
            Save iteration
          </button>
          <button id="validate-button" class="inline-flex items-center gap-2 rounded-xl border border-sky-500/50 bg-sky-400/10 px-4 py-2 text-sm font-semibold text-sky-100 transition hover:border-sky-300 hover:bg-sky-400/20">
            Validate now
          </button>
        </div>
        <textarea id="document-editor" class="h-64 w-full rounded-2xl border border-slate-800 bg-slate-950/70 px-4 py-3 text-sm text-slate-100 outline-none ring-emerald-400/30 focus:ring" placeholder="Load a document to view and iterate on its content."></textarea>
        <div id="validation-output" class="rounded-2xl border border-slate-800 bg-slate-950/60 px-4 py-3 text-sm text-slate-200">
          <p class="text-xs uppercase tracking-[0.16em] text-emerald-200">Validation</p>
          <p class="mt-1 text-slate-300">Run validation to see completion, warnings, and blocking failures.</p>
        </div>
      </div>
    </section>

    <section class="rounded-3xl border border-slate-800 bg-slate-900/70 p-6 shadow-lg shadow-slate-900/50 ring-1 ring-white/5">
      <div class="flex flex-wrap items-start justify-between gap-4">
        <div>
          <p class="text-xs uppercase tracking-[0.16em] text-sky-200">Workflow execution</p>
          <h3 class="text-xl font-semibold text-white">Kick off, resume, or mark iterations</h3>
          <p class="text-sm text-slate-400">Send execution commands and capture status updates with a live timeline.</p>
        </div>
        <div class="rounded-xl border border-slate-800 bg-slate-950/70 px-3 py-2 text-xs text-slate-300">
          <p>Active status: <span id="active-status" class="font-semibold text-emerald-300">{{ workflow_state.active_execution.status if workflow_state.active_execution else "idle" }}</span></p>
          <p>Workflow params: <span id="workflow-params-chip" class="text-sky-200">{{ workflow_state.workflow_params or {} }}</span></p>
        </div>
      </div>
      <div class="mt-4 grid gap-4 lg:grid-cols-2">
        <form id="execute-form" class="space-y-3 rounded-2xl border border-slate-800 bg-slate-950/70 p-4">
          <p class="text-sm font-semibold text-slate-100">Start / resume workflow</p>
          <label class="block text-sm text-slate-200">
            Workflow params (JSON, optional)
            <textarea id="workflow-params" class="mt-1 h-20 w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-sm text-slate-100 outline-none ring-emerald-400/30 focus:ring" placeholder='{"max_steps": 3, "dry_run": false}'></textarea>
          </label>
          <div class="flex flex-wrap gap-3">
            <button type="submit" class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-indigo-500 via-sky-500 to-emerald-400 px-4 py-2 text-sm font-semibold text-slate-950 shadow-md shadow-sky-500/30 transition hover:translate-y-[-1px] hover:shadow-sky-400/40">
              Execute workflow
            </button>
            <button type="button" id="refresh-status" class="inline-flex items-center gap-2 rounded-xl border border-slate-700 px-4 py-2 text-sm font-semibold text-slate-100 transition hover:border-slate-500 hover:bg-slate-800/60">
              Refresh status
            </button>
          </div>
        </form>

        <form id="status-update-form" class="space-y-3 rounded-2xl border border-slate-800 bg-slate-950/70 p-4">
          <p class="text-sm font-semibold text-slate-100">Iteration status update</p>
          <label class="block text-sm text-slate-200">
            Status
            <select id="status-select" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-sm text-slate-100 outline-none ring-emerald-400/30 focus:ring">
              <option value="running">running</option>
              <option value="queued">queued</option>
              <option value="blocked">blocked</option>
              <option value="completed">completed</option>
              <option value="failed">failed</option>
              <option value="canceled">canceled</option>
            </select>
          </label>
          <label class="block text-sm text-slate-200">
            Message
            <input id="status-message" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-sm text-slate-100 outline-none ring-emerald-400/30 focus:ring" placeholder="Iteration note or status update" />
          </label>
          <label class="block text-sm text-slate-200">
            Blocked reason (optional)
            <input id="blocked-reason" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2 text-sm text-slate-100 outline-none ring-emerald-400/30 focus:ring" placeholder="If blocked, specify why" />
          </label>
          <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-slate-700 px-4 py-2 text-sm font-semibold text-slate-100 transition hover:border-slate-500 hover:bg-slate-800/60">
            Append update
          </button>
        </form>
      </div>
    </section>
  </div>

  <div class="space-y-6">
    <section class="rounded-3xl border border-slate-800 bg-slate-900/70 p-5 shadow-lg shadow-slate-900/50 ring-1 ring-white/5">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs uppercase tracking-[0.14em] text-sky-200">Document library</p>
          <p class="text-sm text-slate-400">Files discovered under docs/</p>
        </div>
        <span class="rounded-full border border-slate-800 bg-slate-950/70 px-3 py-1 text-xs font-semibold text-emerald-200">
          {{ documents|length }} docs
        </span>
      </div>
      <div id="document-list" class="mt-4 space-y-3">
        {% for doc in documents %}
          <article class="rounded-2xl border border-slate-800 bg-slate-950/70 p-4 text-sm text-slate-200">
            <div class="flex items-center justify-between gap-3">
              <p class="font-semibold text-sky-100 break-all">{{ doc.name }}</p>
              <span class="rounded-full border border-slate-700 bg-slate-800 px-3 py-1 text-xs font-semibold uppercase tracking-[0.12em] text-emerald-200">
                {{ doc.status }}
              </span>
            </div>
            <p class="mt-2 text-xs text-slate-400">Updated {{ doc.updated_at.strftime("%b %d, %Y %H:%M UTC") }}</p>
          </article>
        {% else %}
          <p class="text-slate-400">No documents registered yet.</p>
        {% endfor %}
      </div>
    </section>

    <section class="rounded-3xl border border-slate-800 bg-slate-900/70 p-5 shadow-lg shadow-slate-900/50 ring-1 ring-white/5">
      <div class="flex items-center justify-between">
        <p class="text-xs uppercase tracking-[0.14em] text-sky-200">Execution timeline</p>
        <span class="rounded-full border border-slate-800 bg-slate-950/70 px-3 py-1 text-xs font-semibold text-slate-200" id="log-count">
          {{ workflow_state.execution_log|length }} events
        </span>
      </div>
      <div id="execution-log" class="mt-3 space-y-2 text-sm text-slate-200">
        {% for entry in workflow_state.execution_log %}
          <div class="rounded-xl border border-slate-800 bg-slate-950/70 px-3 py-2">
            <p class="text-xs text-slate-400">{{ entry.timestamp }}</p>
            <p class="font-semibold text-emerald-200">{{ entry.status|capitalize }}</p>
            <p class="text-slate-200">{{ entry.message }}</p>
            {% if entry.blocked_reason %}
              <p class="text-xs text-amber-200">Blocked: {{ entry.blocked_reason }}</p>
            {% endif %}
          </div>
        {% else %}
          <p class="text-slate-400">No execution events yet.</p>
        {% endfor %}
      </div>
    </section>

    <section class="rounded-3xl border border-slate-800 bg-slate-900/70 p-5 shadow-lg shadow-slate-900/50 ring-1 ring-white/5">
      <p class="text-xs uppercase tracking-[0.14em] text-sky-200">UI tokens</p>
      <p class="mt-2 text-sm text-slate-300">Core styles for the Codex-inspired surface.</p>
      <dl class="mt-4 space-y-2 text-sm text-slate-200">
        <div class="flex items-center justify-between gap-3 rounded-xl border border-slate-800 bg-slate-950/70 px-3 py-2">
          <dt>Typography</dt>
          <dd class="text-slate-400">Space Grotesk + IBM Plex Mono</dd>
        </div>
        <div class="flex items-center justify-between gap-3 rounded-xl border border-slate-800 bg-slate-950/70 px-3 py-2">
          <dt>Surfaces</dt>
          <dd class="text-slate-400">Slate 950 / 900 with subtle rings</dd>
        </div>
        <div class="flex items-center justify-between gap-3 rounded-xl border border-slate-800 bg-slate-950/70 px-3 py-2">
          <dt>Accents</dt>
          <dd class="text-slate-400">Indigo → Sky → Emerald gradients</dd>
        </div>
        <div class="flex items-center justify-between gap-3 rounded-xl border border-slate-800 bg-slate-950/70 px-3 py-2">
          <dt>Density</dt>
          <dd class="text-slate-400">Rounded-2xl cards, tight line-height</dd>
        </div>
      </dl>
    </section>
  </div>
</div>

<script>
  const initialDocuments = {{ documents | tojson }};
  const workflowState = {{ workflow_state | tojson }};
  const defaults = {{ defaults | tojson }};

  const docInputs = Array.from(document.querySelectorAll("[data-doc-path]"));
  const repoRootInput = document.getElementById("repo-root");
  const docNameInput = document.getElementById("doc-name");
  const templateInput = document.getElementById("template-path");
  const docEditor = document.getElementById("document-editor");
  const toast = document.getElementById("action-toast");
  const activeDocChip = document.getElementById("active-doc-chip");
  const activeStatusChip = document.getElementById("active-status");
  const workflowParamsChip = document.getElementById("workflow-params-chip");
  const executionLogEl = document.getElementById("execution-log");
  const logCountEl = document.getElementById("log-count");
  const validationOutput = document.getElementById("validation-output");

  let executionLog = Array.isArray(workflowState.execution_log) ? [...workflowState.execution_log] : [];
  let logCursor = executionLog.length;
  let documentList = Array.isArray(initialDocuments) ? [...initialDocuments] : [];
  let docPathTouched = false;

  docInputs.forEach((input) => {
    input.addEventListener("input", () => {
      docPathTouched = true;
    });
  });

  function readCookie(name) {
    const match = document.cookie.split("; ").find((row) => row.startsWith(name + "="));
    return match ? decodeURIComponent(match.split("=").slice(1).join("=")) : "";
  }

  function getCsrfToken() {
    const meta = document.querySelector('meta[name="csrf-token"]');
    if (meta && meta.content) {
      return meta.content;
    }
    return readCookie("csrf_token");
  }

  function refreshCsrfTokenFromResponse(resp) {
    const nextToken = resp.headers.get("X-CSRFToken");
    if (!nextToken) return;
    const meta = document.querySelector('meta[name="csrf-token"]');
    if (meta) {
      meta.setAttribute("content", nextToken);
    }
    document.cookie = `csrf_token=${encodeURIComponent(nextToken)}; SameSite=Lax; Path=/`;
  }

  function setDocPath(value) {
    docInputs.forEach((input) => {
      input.value = value;
    });
    if (docNameInput) {
      if (value) {
        const parts = value.split(/[\\/]/);
        docNameInput.value = parts[parts.length - 1] || value;
      } else {
        docNameInput.value = "";
      }
    }
    activeDocChip.textContent = value || "None";
  }

  function getDocPath() {
    const target = docInputs[0];
    return target ? target.value.trim() : "";
  }

  function defaultDocDir() {
    const raw = defaults.document_path || "";
    if (raw.includes("/")) {
      return raw.split("/").slice(0, -1).join("/");
    }
    return "docs";
  }

  function suggestedDocPath(name) {
    if (!name) return "";
    const cleanName = name.endsWith(".md") ? name : `${name}.md`;
    const dir = defaultDocDir();
    return dir ? `${dir}/${cleanName}` : cleanName;
  }

  function setToast(message, tone = "muted") {
    toast.textContent = message;
    toast.className = "rounded-full border px-3 py-1 text-xs " + (tone === "error"
      ? "border-rose-500/50 bg-rose-500/10 text-rose-100"
      : tone === "success"
        ? "border-emerald-500/50 bg-emerald-500/10 text-emerald-100"
        : "border-slate-700 bg-slate-900/70 text-slate-300");
  }

  function validateRelativePath(raw, label) {
    if (!raw) return `${label} is required`;
    if (raw.startsWith("/") || raw.startsWith("~")) return `${label} must be relative to the repo root`;
    if (raw.includes("..")) return `${label} cannot include '..'`;
    if (raw.length > 300) return `${label} is too long`;
    return "";
  }

  function validateCreateInputs() {
    const templatePath = templateInput.value.trim();
    const docName = docNameInput ? docNameInput.value.trim() : "";
    let docPath = getDocPath();

    if (!docPath && docName) {
      const suggested = suggestedDocPath(docName);
      if (suggested) {
        setDocPath(suggested);
        docPath = suggested;
      }
    }

    const errors = [];
    if (repoRootInput && !repoRootInput.value.trim()) {
      errors.push("Repo root is missing; reload the page.");
    }
    const templateError = validateRelativePath(templatePath, "Template path");
    if (templateError) errors.push(templateError);
    if (docNameInput && !docName) errors.push("Document name is required");
    if (docName && /[\\/]/.test(docName)) {
      errors.push("Document name should not include directory separators");
    }
    const docError = validateRelativePath(docPath, "Document path");
    if (docError) errors.push(docError);
    if (docPath && !docPath.endsWith(".md")) {
      errors.push("Document path must end with .md");
    }

    if (errors.length) {
      setToast(errors[0], "error");
      return null;
    }
    return {templatePath, docPath};
  }

  function renderLog() {
    if (!executionLogEl) return;
    executionLogEl.innerHTML = "";
    if (executionLog.length === 0) {
      executionLogEl.innerHTML = '<p class="text-slate-400">No execution events yet.</p>';
      if (logCountEl) logCountEl.textContent = "0 events";
      return;
    }
    executionLog.slice().reverse().forEach((entry) => {
      const item = document.createElement("div");
      item.className = "rounded-xl border border-slate-800 bg-slate-950/70 px-3 py-2";
      const ts = document.createElement("p");
      ts.className = "text-xs text-slate-400";
      ts.textContent = entry.timestamp || "";
      const status = document.createElement("p");
      status.className = "font-semibold text-emerald-200";
      status.textContent = (entry.status || "").toString().toUpperCase();
      const message = document.createElement("p");
      message.className = "text-slate-200";
      message.textContent = entry.message || "";
      item.append(ts, status, message);
      if (entry.blocked_reason) {
        const blocked = document.createElement("p");
        blocked.className = "text-xs text-amber-200";
        blocked.textContent = "Blocked: " + entry.blocked_reason;
        item.appendChild(blocked);
      }
      executionLogEl.appendChild(item);
    });
    if (logCountEl) logCountEl.textContent = executionLog.length + " events";
  }

  function updateDocumentList(documents) {
    const container = document.getElementById("document-list");
    if (!container) return;
    container.innerHTML = "";
    if (!documents || documents.length === 0) {
      container.innerHTML = '<p class="text-slate-400">No documents registered yet.</p>';
      return;
    }
    documents.forEach((doc) => {
      const card = document.createElement("article");
      card.className = "rounded-2xl border border-slate-800 bg-slate-950/70 p-4 text-sm text-slate-200";
      const top = document.createElement("div");
      top.className = "flex items-center justify-between gap-3";
      const name = document.createElement("p");
      name.className = "font-semibold text-sky-100 break-all";
      name.textContent = doc.name;
      const badge = document.createElement("span");
      badge.className = "rounded-full border border-slate-700 bg-slate-800 px-3 py-1 text-xs font-semibold uppercase tracking-[0.12em] text-emerald-200";
      badge.textContent = doc.status || "idle";
      top.append(name, badge);
      const meta = document.createElement("p");
      meta.className = "mt-2 text-xs text-slate-400";
      const stamp = doc.updated_at_iso || doc.updated_at;
      meta.textContent = stamp ? "Updated " + new Date(stamp).toLocaleString() : "Updated";
      card.append(top, meta);
      container.appendChild(card);
    });
  }

  function updateActiveExecution(active) {
    const status = active && active.status ? active.status : "idle";
    if (activeStatusChip) activeStatusChip.textContent = status;
    if (active && active.doc) {
      setDocPath(active.doc);
    }
  }

  function hydrateFromState() {
    setDocPath(workflowState.current_doc || defaults.document_path || "");
    renderLog();
    updateDocumentList(documentList);
  }

  async function fetchJson(url, options = {}) {
    const headers = {"Content-Type": "application/json", ...(options.headers || {})};
    const csrfToken = getCsrfToken();
    if (csrfToken) {
      headers["X-CSRFToken"] = csrfToken;
    }
    const resp = await fetch(url, {
      headers,
      ...options,
    });
    refreshCsrfTokenFromResponse(resp);
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) {
      const parts = [];
      if (data && typeof data === "object") {
        if (data.error) parts.push(data.error);
        if (!data.error && data.message) parts.push(data.message);
        if (data.details) parts.push(data.details);
      }
      const msg = parts.filter(Boolean).join(": ") || "Request failed";
      throw new Error(msg);
    }
    return data;
  }

  async function loadDocument() {
    const path = getDocPath();
    if (!path) {
      setToast("Provide a document path before loading", "error");
      return;
    }
    setToast("Loading document …");
    try {
      const data = await fetchJson(`/api/document/content?path=${encodeURIComponent(path)}`);
      docEditor.value = data.content || "";
      setDocPath(data.path || path);
      setToast("Loaded document", "success");
    } catch (err) {
      setToast(err.message, "error");
    }
  }

  async function saveDocument() {
    const path = getDocPath();
    if (!path) {
      setToast("Set a document path before saving", "error");
      return;
    }
    setToast("Saving iteration …");
    try {
      const data = await fetchJson("/api/document/content", {
        method: "POST",
        body: JSON.stringify({document_path: path, content: docEditor.value || ""}),
      });
      setToast("Saved iteration", "success");
      setDocPath(data.document_path || path);
    } catch (err) {
      setToast(err.message, "error");
    }
  }

  async function validateDocument() {
    const path = getDocPath();
    if (!path) {
      setToast("Set a document path before validating", "error");
      return;
    }
    setToast("Validating …");
    try {
      const data = await fetchJson("/api/document/validate", {
        method: "POST",
        body: JSON.stringify({document_path: path, strict: true}),
      });
      validationOutput.innerHTML = `
        <p class="text-xs uppercase tracking-[0.16em] text-emerald-200">Validation</p>
        <p class="mt-1 text-slate-100 font-semibold">${data.complete ? "Complete" : "Incomplete"}</p>
        <p class="text-slate-300">Blocking: ${(data.blocking_failures || []).length} | Warnings: ${(data.warnings || []).length}</p>
      `;
      setToast("Validation finished", "success");
    } catch (err) {
      setToast(err.message, "error");
    }
  }

  async function executeWorkflow() {
    const path = getDocPath();
    if (!path) {
      setToast("Set a document path before executing", "error");
      return;
    }
    let params = {};
    const rawParams = document.getElementById("workflow-params").value.trim();
    if (rawParams) {
      try {
        params = JSON.parse(rawParams);
      } catch (err) {
        setToast("Workflow params must be valid JSON", "error");
        return;
      }
    }
    setToast("Starting execution …");
    try {
      const data = await fetchJson("/api/document/execute", {
        method: "POST",
        body: JSON.stringify({document_path: path, workflow_params: params}),
      });
      executionLog = data.execution_log || executionLog;
      logCursor = executionLog.length;
      renderLog();
      updateActiveExecution(data.active_execution);
      workflowParamsChip.textContent = JSON.stringify(data.workflow_params || params || {});
      setToast("Execution marked as running", "success");
    } catch (err) {
      setToast(err.message, "error");
    }
  }

  async function refreshStatus() {
    try {
      const data = await fetchJson(`/api/document/status?since=${logCursor}`);
      if (Array.isArray(data.execution_log) && data.execution_log.length) {
        executionLog = executionLog.concat(data.execution_log);
        logCursor = data.log_cursor || executionLog.length;
        renderLog();
      }
      updateActiveExecution(data.active_execution);
      workflowParamsChip.textContent = JSON.stringify(data.workflow_params || {});
      setToast("Status refreshed", "success");
    } catch (err) {
      setToast(err.message, "error");
    }
  }

  async function appendStatusUpdate() {
    const path = getDocPath();
    const status = document.getElementById("status-select").value;
    const message = document.getElementById("status-message").value;
    const blocked = document.getElementById("blocked-reason").value;
    setToast("Posting update …");
    try {
      const data = await fetchJson("/api/document/execute/status", {
        method: "POST",
        body: JSON.stringify({
          status,
          message,
          blocked_reason: blocked || null,
          document_path: path,
        }),
      });
      executionLog = data.execution_log || executionLog;
      logCursor = data.log_cursor || executionLog.length;
      renderLog();
      updateActiveExecution(data.active_execution);
      setToast("Update added", "success");
    } catch (err) {
      setToast(err.message, "error");
    }
  }

  function wireEvents() {
    docNameInput?.addEventListener("input", () => {
      if (docPathTouched) return;
      const suggestion = suggestedDocPath(docNameInput.value.trim());
      if (suggestion) {
        setDocPath(suggestion);
      }
    });

    document.getElementById("create-form")?.addEventListener("submit", async (event) => {
      event.preventDefault();
      const validated = validateCreateInputs();
      if (!validated) return;
      const {templatePath, docPath} = validated;
      setToast("Creating document …");
      try {
        const data = await fetchJson("/api/document/create", {
          method: "POST",
          body: JSON.stringify({template_path: templatePath, document_path: docPath}),
        });
        const createdPath = data && data.document ? data.document.path : docPath;
        setToast(`Created ${createdPath} from template`, "success");
        setDocPath(createdPath);
        loadDocument();
        documentList = documentList.filter((doc) => doc.name !== createdPath);
        documentList.unshift({
          name: createdPath,
          status: "ready",
          updated_at_iso: new Date().toISOString(),
        });
        updateDocumentList(documentList);
      } catch (err) {
        setToast(err.message, "error");
      }
    });

    document.getElementById("load-button")?.addEventListener("click", (e) => {
      e.preventDefault();
      loadDocument();
    });
    document.getElementById("save-button")?.addEventListener("click", (e) => {
      e.preventDefault();
      saveDocument();
    });
    document.getElementById("validate-button")?.addEventListener("click", (e) => {
      e.preventDefault();
      validateDocument();
    });
    document.getElementById("execute-form")?.addEventListener("submit", (e) => {
      e.preventDefault();
      executeWorkflow();
    });
    document.getElementById("refresh-status")?.addEventListener("click", (e) => {
      e.preventDefault();
      refreshStatus();
    });
    document.getElementById("status-update-form")?.addEventListener("submit", (e) => {
      e.preventDefault();
      appendStatusUpdate();
    });
  }

  hydrateFromState();
  wireEvents();
</script>
{% endblock %}
