# ============================================================================
# Auto-Merge Coding Agent PRs Workflow
# ============================================================================
# Purpose: Automatically merges pull requests created by the coding agent
#          (github-actions[bot]) after all required status checks pass.
#          This enables a fully automated workflow for sub-issue completion.
#
# Flow:
#   PR opened/updated ‚Üí Validate epic branch ‚Üí Add labels ‚Üí
#   Wait for checks ‚Üí Enable auto-merge ‚Üí Confirm
#
# Trigger: When PRs are opened, synchronized, or reopened
# ============================================================================

name: Auto-Merge Coding Agent PRs

# Trigger on pull request events
on:
  pull_request:
    types: [opened, synchronize, reopened]

# Permissions needed for this workflow
permissions:
  contents: write       # Required to enable auto-merge
  pull-requests: write  # Required to modify PR labels and settings

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    
    # ========================================================================
    # Job Condition: Only run for coding agent PRs
    # ========================================================================
    # This workflow should only execute for PRs created by:
    # 1. The github-actions[bot] user, OR
    # 2. PRs labeled with 'coding-agent'
    # 
    # This ensures we don't auto-merge PRs created by human developers
    # ========================================================================
    if: |
      github.event.pull_request.user.login == 'github-actions[bot]' ||
      contains(github.event.pull_request.labels.*.name, 'coding-agent')
    
    steps:
      # ======================================================================
      # Step 1: Validate Epic Branch Target
      # ======================================================================
      # Ensures the PR is targeting an Epic branch (format: epic-XXX)
      # 
      # This validation prevents auto-merge from being enabled on:
      # - PRs targeting main branch
      # - PRs targeting feature branches
      # - PRs targeting other non-epic branches
      # 
      # Only PRs that are part of the Epic workflow should be auto-merged
      # ======================================================================
      - name: Validate epic branch target
        id: validate
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const baseBranch = pr.base.ref;
            
            // Check if base branch matches epic-XXX pattern
            const isEpicBranch = /^epic-\d+$/.test(baseBranch);
            
            if (!isEpicBranch) {
              console.log('‚ö†Ô∏è  Base branch is not an Epic branch: ' + baseBranch);
              console.log('   Auto-merge will not be enabled');
              core.setOutput('is_epic_branch', 'false');
              return;
            }
            
            // Extract epic number from branch name
            const epicNumber = baseBranch.match(/^epic-(\d+)$/)[1];
            
            console.log('‚úÖ Valid Epic branch: ' + baseBranch);
            console.log('   Epic number: #' + epicNumber);
            
            core.setOutput('is_epic_branch', 'true');
            core.setOutput('epic_number', epicNumber);
            core.setOutput('epic_branch', baseBranch);
            
      # ======================================================================
      # Step 2: Add Epic Label to PR
      # ======================================================================
      # Adds a label to the PR indicating which Epic it belongs to
      # Format: epic-XXX
      # 
      # This label helps with:
      # - Filtering PRs by Epic
      # - Tracking which Epic a PR belongs to
      # - Quick visual identification in PR lists
      # ======================================================================
      - name: Add epic label to PR
        if: steps.validate.outputs.is_epic_branch == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const epicBranch = '${{ steps.validate.outputs.epic_branch }}';
            const prNumber = context.payload.pull_request.number;
            
            try {
              // Add the epic branch name as a label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: [epicBranch, 'coding-agent']
              });
              
              console.log('‚úÖ Labels added to PR #' + prNumber);
              console.log('   - ' + epicBranch);
              console.log('   - coding-agent');
            } catch (error) {
              console.log('‚ö†Ô∏è  Could not add labels: ' + error.message);
              // Don't fail the workflow if labels can't be added
            }
            
      # ======================================================================
      # Step 3: Wait for Status Checks
      # ======================================================================
      # Polls the PR status checks until they complete
      # 
      # Configuration:
      # - Max attempts: 30 (up to 5 minutes total wait time)
      # - Interval: 10 seconds between checks
      # - Timeout: Fails after 30 attempts if checks don't pass
      # 
      # The workflow waits for:
      # - All required status checks to complete
      # - All checks to pass (success status)
      # 
      # If any check fails, the workflow fails and auto-merge is not enabled
      # ======================================================================
      - name: Wait for status checks to complete
        if: steps.validate.outputs.is_epic_branch == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const maxAttempts = 30;  // Maximum number of polling attempts
            const interval = 10000;  // 10 seconds between attempts
            
            console.log('‚è≥ Waiting for status checks to complete...');
            console.log(`   Max attempts: ${maxAttempts}`);
            console.log(`   Check interval: ${interval / 1000} seconds`);
            
            let attempt = 0;
            let allChecksPassed = false;
            
            while (attempt < maxAttempts && !allChecksPassed) {
              attempt++;
              console.log(`\nüîç Attempt ${attempt}/${maxAttempts}`);
              
              // Get combined status for the PR
              const { data: combinedStatus } = await github.rest.repos.getCombinedStatusForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: context.payload.pull_request.head.sha
              });
              
              console.log(`   Combined status: ${combinedStatus.state}`);
              console.log(`   Statuses: ${combinedStatus.statuses.length}`);
              
              // Check if all statuses are successful
              if (combinedStatus.state === 'success' || combinedStatus.statuses.length === 0) {
                allChecksPassed = true;
                console.log('‚úÖ All status checks passed!');
                break;
              }
              
              if (combinedStatus.state === 'failure') {
                core.setFailed('‚ùå Status checks failed');
                return;
              }
              
              // Log status of each check
              for (const status of combinedStatus.statuses) {
                console.log(`   - ${status.context}: ${status.state}`);
              }
              
              // Wait before next attempt
              if (attempt < maxAttempts && !allChecksPassed) {
                console.log(`   Waiting ${interval / 1000} seconds before next check...`);
                await new Promise(resolve => setTimeout(resolve, interval));
              }
            }
            
            if (!allChecksPassed) {
              core.setFailed('‚ùå Timeout waiting for status checks');
              return;
            }
            
      # ======================================================================
      # Step 4: Enable Auto-Merge
      # ======================================================================
      # Enables auto-merge on the PR with the squash merge method
      # 
      # Why squash merge?
      # - Keeps Epic branch history clean
      # - Each sub-issue becomes a single commit
      # - Easier to revert if needed
      # - Better for release notes and changelogs
      # 
      # Once enabled, GitHub will automatically merge the PR when:
      # - All required status checks pass
      # - All required reviews are approved
      # - No blocking reviews exist
      # ======================================================================
      - name: Enable auto-merge
        if: steps.validate.outputs.is_epic_branch == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const prNodeId = context.payload.pull_request.node_id;
            
            try {
              // Enable auto-merge using GraphQL API
              // (REST API doesn't support auto-merge yet)
              const mutation = `
                mutation($pullRequestId: ID!, $mergeMethod: PullRequestMergeMethod!) {
                  enablePullRequestAutoMerge(input: {
                    pullRequestId: $pullRequestId,
                    mergeMethod: $mergeMethod
                  }) {
                    pullRequest {
                      autoMergeRequest {
                        enabledAt
                        enabledBy {
                          login
                        }
                      }
                    }
                  }
                }
              `;
              
              const result = await github.graphql(mutation, {
                pullRequestId: prNodeId,
                mergeMethod: 'SQUASH'
              });
              
              console.log('‚úÖ Auto-merge enabled for PR #' + prNumber);
              console.log('   Merge method: SQUASH');
              console.log('   Enabled at: ' + result.enablePullRequestAutoMerge.pullRequest.autoMergeRequest.enabledAt);
            } catch (error) {
              console.log('‚ö†Ô∏è  Could not enable auto-merge: ' + error.message);
              console.log('   This may require additional repository settings');
              // Don't fail the workflow if auto-merge can't be enabled
              // It might not be available on the repository plan
            }
            
      # ======================================================================
      # Step 5: Add Confirmation Comment
      # ======================================================================
      # Posts a comment on the PR confirming that auto-merge has been enabled
      # 
      # The comment includes:
      # - Confirmation that auto-merge is enabled
      # - Information about the merge method
      # - What will happen after merge
      # - Link to the parent Epic
      # 
      # This provides transparency about the automated process
      # ======================================================================
      - name: Add confirmation comment
        if: steps.validate.outputs.is_epic_branch == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const epicNumber = '${{ steps.validate.outputs.epic_number }}';
            const epicBranch = '${{ steps.validate.outputs.epic_branch }}';
            
            const message = `
            ## ‚úÖ Auto-Merge Enabled
            
            This PR has been automatically configured for merging.
            
            ### Merge Configuration
            - **Method:** Squash and merge
            - **Target:** \`${epicBranch}\`
            - **Parent Epic:** #${epicNumber}
            
            ### What Happens Next
            
            1. ‚úÖ This PR will be automatically merged when all checks pass
            2. ‚úÖ Progress will be updated on Epic #${epicNumber}
            3. ‚úÖ Next sub-issue will be automatically assigned
            4. ‚úÖ If this was the last issue, Epic will be marked complete
            
            ### Automation Workflow
            \`\`\`
            PR merged ‚Üí Update Epic progress ‚Üí Assign next issue ‚Üí Coding agent works ‚Üí PR created ‚Üí Auto-merge
            \`\`\`
            
            ---
            
            ü§ñ *This is an automated message from the three-tier branching workflow*
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: message
            });
            
            console.log('‚úÖ Confirmation comment posted to PR #' + prNumber);
